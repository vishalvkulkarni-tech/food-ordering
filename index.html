<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Food Order App</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    h1 { text-align: center; }
    .menu-item { display: flex; justify-content: space-between; padding: 10px 0; }
    .menu-item input { width: 60px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Food Order</h1>
  <form id="orderForm">
    <div id="menuSection"></div>
    <hr/>
    <label>Name: <input name="name" required /></label><br/><br/>
    <label>Phone: <input name="phone" required /></label><br/><br/>
    <label>Address: <textarea name="address" required></textarea></label><br/><br/>
    <label>Upload Payment Screenshot: <input type="file" id="paymentImg" required /></label><br/><br/>
    <button type="submit">Submit Order</button>
  </form>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwgfbXBfU3MDUDUb4gPelPPJ1_52phISM-zZ_hT1QNGSRYH2zmbH4AZTJjuL6cEW6q6LA/exec';

    let CONFIG = {};
    let MENU = [];

    async function fetchData() {
      const res = await fetch(scriptURL + '?action=config');
      const data = await res.json();
      CONFIG = data.config;
      MENU = data.menu;
      if (CONFIG.LIVE === 'TRUE') buildMenu();
      else document.getElementById('orderForm').innerHTML = '<h3>Ordering is currently closed.</h3>';
    }

    function buildMenu() {
      const menuDiv = document.getElementById('menuSection');
      MENU.forEach((item, index) => {
        if (item.Available === 'TRUE') {
          const div = document.createElement('div');
          div.className = 'menu-item';
          div.innerHTML = `
            <label>${item.Name} (â‚¹${item.Price})</label>
            <input type="number" name="qty_${index}" min="0" placeholder="Qty" />
          `;
          menuDiv.appendChild(div);
        }
      });
    }

    document.getElementById('orderForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);
      const menuOrdered = [];
      let total = 0;

      MENU.forEach((item, i) => {
        const qty = parseInt(formData.get(`qty_${i}`)) || 0;
        if (qty > 0) {
          menuOrdered.push(`${qty} x ${item.Name}`);
          total += qty * parseFloat(item.Price);
        }
      });

      if (menuOrdered.length === 0) return alert("Please select at least 1 item.");

      const paymentFile = document.getElementById('paymentImg').files[0];
      if (!paymentFile) return alert("Please upload payment screenshot.");

      const base64 = await toBase64(paymentFile);

      const postData = {
        name: formData.get("name"),
        phone: formData.get("phone"),
        address: formData.get("address"),
        menuSummary: menuOrdered.join(", "),
        total,
        paymentBase64: base64
      };

      const res = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(postData)
      });

      const result = await res.json();
      if (result.status === 'SUCCESS') alert("Order submitted!");
      else alert("Error: " + result.message);
      form.reset();
    });

    const toBase64 = file => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

    fetchData();
  </script>
</body>
</html>
