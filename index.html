<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <script>
      let config = {};
      let menu = [];

      window.onload = async () => {
        const response = await google.script.run.withSuccessHandler(init).getData;
      };

      function init(data) {
        config = data.config;
        menu = data.menu;
        renderMenu();
        document.getElementById("userForm").style.display = config.LIVE ? "block" : "none";
      }

      function renderMenu() {
        const menuContainer = document.getElementById("menuContainer");
        menu.forEach((item, index) => {
          const div = document.createElement("div");
          div.innerHTML = `
            <label>
              <input type="checkbox" onchange="updateTotal()" data-price="${item.Price}" value="${item.Item}" />
              ${item.Item} - ₹${item.Price}
            </label>`;
          menuContainer.appendChild(div);
        });
      }

      function updateTotal() {
        let total = 0;
        document.querySelectorAll("#menuContainer input[type=checkbox]:checked").forEach(cb => {
          total += parseFloat(cb.dataset.price);
        });
        document.getElementById("totalAmount").innerText = total;
        document.getElementById("paymentButton").style.display = total > 0 ? "block" : "none";
        document.getElementById("qrSection").style.display = "none";
      }

      function generateQR() {
        const amount = document.getElementById("totalAmount").innerText;
        if (!amount || amount == 0) return;
        const upi = config.UPI_ID;
        const name = config.UPI_NAME;
        const url = `https://upi-qr-code.vercel.app/api/qr?upi=${upi}&name=${name}&amount=${amount}`;
        document.getElementById("qrCode").src = url;
        document.getElementById("qrSection").style.display = "block";
        document.getElementById("paymentButton").style.display = "none";

        setTimeout(() => {
          document.getElementById("confirmPayment").style.display = "block";
        }, 30000);
      }

      function submitOrder() {
        const selectedItems = Array.from(document.querySelectorAll("#menuContainer input[type=checkbox]:checked"))
          .map(cb => cb.value);
        const total = document.getElementById("totalAmount").innerText;
        const name = document.getElementById("name").value;
        const phone = document.getElementById("phone").value;

        if (!name || !phone || selectedItems.length === 0) {
          alert("Please complete all details and select items.");
          return;
        }

        const order = {
          name,
          phone,
          items: selectedItems,
          total
        };

        google.script.run.withSuccessHandler(() => {
          alert("Order submitted successfully!");
          window.location.reload();
        }).submitOrder(order);
      }
    </script>
  </head>
  <body>
    <h2>Menu</h2>
    <div id="menuContainer"></div>
    <h3>Total: ₹<span id="totalAmount">0</span></h3>
    <button id="paymentButton" style="display:none;" onclick="generateQR()">Click here to Pay</button>

    <div id="qrSection" style="display:none;">
      <h3>Scan to Pay</h3>
      <img id="qrCode" src="" width="200" />
      <br />
      <button id="confirmPayment" style="display:none;" onclick="submitOrder()">I have paid</button>
    </div>

    <div id="userForm" style="margin-top:20px;">
      <h3>Your Info</h3>
      <label>Name: <input type="text" id="name" /></label><br />
      <label>Phone: <input type="text" id="phone" /></label>
    </div>
  </body>
</html>

