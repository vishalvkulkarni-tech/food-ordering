<!DOCTYPE html>
<html>
<head>
  <title>Food Order</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    h2 { color: #007bff; }
    label { display: block; margin: 10px 0 5px; }
    .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .item-row input[type="number"] { width: 60px; }
    .total { font-weight: bold; margin-top: 10px; }
    .disabled { color: gray; }
  </style>
</head>
<body>
  <h2>Order Your Food</h2>
  <div id="menu"></div>

  <div class="total">Total: ₹<span id="total">0</span></div>

  <h3>Your Details</h3>
  <label>Name:</label>
  <input type="text" id="name" required />
  <label>Phone:</label>
  <input type="text" id="phone" required />
  <label>Address:</label>
  <textarea id="address" rows="2"></textarea>

  <h3>UPI Payment</h3>
  <img id="qr" src="https://via.placeholder.com/200x200.png?text=Scan+to+Pay" alt="QR Code" width="200" />

  <br><br>
  <button onclick="submitOrder()">Submit Order</button>

  <script>
    const sheetURL = 'https://script.google.com/macros/s/YOUR_DEPLOYED_SCRIPT_ID/exec';
    let config = {};
    let menuItems = [];

    function fetchConfigAndMenu() {
      fetch(sheetURL + '?action=config')
        .then(res => res.json())
        .then(data => {
          config = data;
          if (config.LIVE !== 'TRUE') {
            document.body.innerHTML = '<h2>Ordering is currently closed.</h2>';
            return;
          }
          fetchMenu();
        });
    }

    function fetchMenu() {
      fetch(sheetURL + '?action=menu')
        .then(res => res.json())
        .then(data => {
          menuItems = data;
          renderMenu();
        });
    }

    function renderMenu() {
      const menuDiv = document.getElementById('menu');
      menuItems.forEach((item, i) => {
        const isAvailable = item.Available === 'TRUE';
        const row = document.createElement('div');
        row.className = 'item-row' + (isAvailable ? '' : ' disabled');
        row.innerHTML = `
          <label>
            <input type="checkbox" ${!isAvailable ? 'disabled' : ''} onchange="toggleItem(${i}, this)">
            ${item.Item} — ₹${item.Price}
          </label>
          <input type="number" id="qty-${i}" value="1" min="1" onchange="updateTotal()" disabled />
        `;
        menuDiv.appendChild(row);
      });
    }

    function toggleItem(index, checkbox) {
      const qtyInput = document.getElementById('qty-' + index);
      qtyInput.disabled = !checkbox.checked;
      updateTotal();
    }

    function updateTotal() {
      let total = 0;
      menuItems.forEach((item, i) => {
        const qtyInput = document.getElementById('qty-' + i);
        const checkbox = qtyInput?.previousElementSibling?.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
          const qty = parseInt(qtyInput.value) || 0;
          total += qty * parseFloat(item.Price);
        }
      });
      document.getElementById('total').innerText = total.toFixed(2);
    }

    function submitOrder() {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      if (!name || !phone) {
        alert('Please enter your name and phone number.');
        return;
      }

      const selectedItems = [];
      menuItems.forEach((item, i) => {
        const checkbox = document.getElementById('qty-' + i).previousElementSibling.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
          const qty = parseInt(document.getElementById('qty-' + i).value) || 1;
          selectedItems.push(`${item.Item} x ${qty}`);
        }
      });

      if (selectedItems.length === 0) {
        alert('Please select at least one item.');
        return;
      }

      const order = {
        name,
        phone,
        address,
        items: selectedItems.join(', '),
        total: document.getElementById('total').innerText,
      };

      fetch(sheetURL, {
        method: 'POST',
        body: JSON.stringify(order),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.text())
      .then(response => {
        alert('Order placed successfully!');
        location.reload();
      })
      .catch(() => alert('Failed to place order.'));
    }

    fetchConfigAndMenu();
  </script>
</body>
</html>
