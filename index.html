<!DOCTYPE html>
<html>
<head>
  <title>Food Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    h2 { color: #333; }
    .menu-item { margin-bottom: 10px; }
    .menu-container { max-height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
    .total { font-weight: bold; margin-top: 15px; }
    .upi-box { margin-top: 20px; text-align: center; }
    .upi-box img { max-width: 200px; }
  </style>
</head>
<body>
  <h2>Menu</h2>
  <form id="orderForm">
    <div class="menu-container" id="menuList">Loading menu...</div>
    <div class="total" id="totalPrice">Total: ₹0</div>
    <h3>Your Details</h3>
    <input type="text" name="name" placeholder="Name" required /><br/><br/>
    <input type="text" name="mobile" placeholder="Mobile" required /><br/><br/>
    <input type="text" name="address" placeholder="Address" required /><br/><br/>
    <button type="submit">Place Order</button>
  </form>

  <div class="upi-box">
    <h3>Pay via UPI</h3>
    <p>Scan & Pay to <strong>Vishal Kulkarni</strong></p>
    <img src="https://upi-qr-code-image-link.com/upi-qr.jpg" alt="UPI QR Code" />
    <p>UPI ID: <strong>vishalkulkarni24@oksbi</strong></p>
  </div>

  <script>
    let menu = [];
    let config = {};
    let menuContainer = document.getElementById('menuList');
    let totalBox = document.getElementById('totalPrice');

    async function fetchMenu() {
      const res = await fetch('https://script.google.com/macros/s/AKfycbwgfbXBfU3MDUDUb4gPelPPJ1_52phISM-zZ_hT1QNGSRYH2zmbH4AZTJjuL6cEW6q6LA/exec?type=menu');
      const data = await res.json();
      menu = data.menu || [];
      config = data.config || {};
      renderMenu();
    }

    function renderMenu() {
      if (config.LIVE !== 'TRUE') {
        menuContainer.innerHTML = '<p>Currently not accepting orders.</p>';
        return;
      }

      menuContainer.innerHTML = '';
      menu.forEach((item, idx) => {
        if (item.Available !== 'TRUE') return;
        let div = document.createElement('div');
        div.className = 'menu-item';
        div.innerHTML = `
          <input type="checkbox" data-index="${idx}" />
          ${item.Item} - ₹${item.Price}
          Qty: <input type="number" min="1" value="1" data-qty-index="${idx}" style="width:50px;" disabled />
        `;
        menuContainer.appendChild(div);
      });

      menuContainer.querySelectorAll('input[type="checkbox"]').forEach(chk => {
        chk.addEventListener('change', updateTotal);
      });

      menuContainer.querySelectorAll('input[type="number"]').forEach(qty => {
        qty.addEventListener('input', updateTotal);
      });

      // Toggle qty box
      menuContainer.addEventListener('change', e => {
        if (e.target.type === 'checkbox') {
          const idx = e.target.getAttribute('data-index');
          const qtyInput = menuContainer.querySelector(`input[data-qty-index="${idx}"]`);
          qtyInput.disabled = !e.target.checked;
        }
      });
    }

    function updateTotal() {
      let total = 0;
      menuContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
        let idx = chk.getAttribute('data-index');
        let qty = parseInt(menuContainer.querySelector(`input[data-qty-index="${idx}"]`).value) || 1;
        total += parseInt(menu[idx].Price) * qty;
      });
      totalBox.innerText = `Total: ₹${total}`;
    }

    document.getElementById('orderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      let form = e.target;
      let items = [];
      let total = 0;

      menuContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
        let idx = chk.getAttribute('data-index');
        let qty = parseInt(menuContainer.querySelector(`input[data-qty-index="${idx}"]`).value) || 1;
        items.push(`${menu[idx].Item} x${qty}`);
        total += parseInt(menu[idx].Price) * qty;
      });

      if (!items.length) return alert('Please select at least one item.');

      const payload = {
        name: form.name.value,
        mobile: form.mobile.value,
        address: form.address.value,
        items: items.join(', '),
        total: total
      };

      const res = await fetch('https://script.google.com/macros/s/AKfycbwgfbXBfU3MDUDUb4gPelPPJ1_52phISM-zZ_hT1QNGSRYH2zmbH4AZTJjuL6cEW6q6LA/exec', {
        method: 'POST',
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      if (result.status === 'success') {
        alert('Order placed!');
        form.reset();
        updateTotal();
      } else {
        alert('Error placing order.');
      }
    });

    fetchMenu();
  </script>
</body>
</html>
