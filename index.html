<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sabudana Laddoo Ordering</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1rem; }
    h1 { color: #333; text-align: center; }
    label { display: block; margin-top: 1rem; font-weight: bold; }
    input[type="text"], input[type="number"] { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
    button { padding: 0.6rem 1rem; margin-top: 1rem; cursor: pointer; }
    #bill, #qrcode-container, #payment-confirmed, #payButton { display: none; }
    .menu-item { margin: 0.5rem 0; }
  </style>
</head>
<body>
  <h1>Order Sabudana Laddoos</h1>

  <div id="menuSection">
    <h3>Menu</h3>
    <div id="menuList"></div>
  </div>

  <label>Name
    <input type="text" id="customerName" placeholder="Your full name" required />
  </label>
  <label>Address
    <input type="text" id="customerAddress" placeholder="Delivery address" required />
  </label>
  <label>Phone Number
    <input type="text" id="customerPhone" placeholder="10-digit mobile" required />
  </label>

  <div id="bill"></div>
  <button id="payButton">Click to Pay</button>

  <div id="qrcode-container">
    <p id="qrText"></p>
    <img id="upiQR" width="200" />
  </div>

  <div id="payment-confirmed">
    <button onclick="submitOrder()">‚úÖ I Have Completed Payment</button>
  </div>

  <script>
    const menuTab = 'Menu';
    const orderTab = 'Orders';
    const configTab = 'Config';
    const SHEET_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwgfbXBfU3MDUDUb4gPelPPJ1_52phISM-zZ_hT1QNGSRYH2zmbH4AZTJjuL6cEW6q6LA/exec'; // Replace with your Apps Script URL

    let CONFIG = {
      LIVE: false,
      TELEGRAM_BOT: false,
      BOT_TOKEN: '',
      CHATID: ''
    };

    let menuItems = [];
    let totalAmount = 0;

    window.onload = async () => {
      await fetchConfig();
      await fetchMenu();
    };

    async function fetchConfig() {
      const res = await fetch(`${SHEET_SCRIPT_URL}?mode=config`);
      const json = await res.json();
      CONFIG.LIVE = json.LIVE === 'TRUE';
      CONFIG.TELEGRAM_BOT = json.TELEGRAM_BOT === 'TRUE';
      CONFIG.BOT_TOKEN = json.BOT_TOKEN;
      CONFIG.CHATID = json.CHATID;
    }

    async function fetchMenu() {
      const res = await fetch(`${SHEET_SCRIPT_URL}?mode=menu`);
      const json = await res.json();
      menuItems = json.filter(item => item.Available === 'TRUE');
      renderMenu(menuItems);
    }

    function renderMenu(items) {
      const menuList = document.getElementById('menuList');
      menuList.innerHTML = '';
      items.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'menu-item';
        div.innerHTML = `
          <input type="checkbox" id="item${i}" onchange="updateBill()"> ${item.Item} - ‚Çπ${item.Price}
          <input type="number" id="qty${i}" min="1" value="1" style="width:60px;" disabled>
        `;
        menuList.appendChild(div);

        document.getElementById(`item${i}`).addEventListener('change', (e) => {
          document.getElementById(`qty${i}`).disabled = !e.target.checked;
        });
      });
    }

    function updateBill() {
      totalAmount = 0;
      let billText = '<h3>Bill Summary</h3>';
      menuItems.forEach((item, i) => {
        const checked = document.getElementById(`item${i}`).checked;
        if (checked) {
          const qty = parseInt(document.getElementById(`qty${i}`).value) || 1;
          const amt = qty * parseFloat(item.Price);
          totalAmount += amt;
          billText += `<div>${item.Item} x ${qty} = ‚Çπ${amt}</div>`;
        }
      });
      document.getElementById('bill').innerHTML = billText + `<h3>Total: ‚Çπ${totalAmount}</h3>`;
      document.getElementById('bill').style.display = totalAmount > 0 ? 'block' : 'none';
      document.getElementById('payButton').style.display = totalAmount > 0 ? 'inline-block' : 'none';
    }

    document.getElementById('payButton').onclick = () => {
      const upi = 'vishalkulkarni258-2@oksbi';
      const name = 'Vishal Kulkarni';
      const url = `https://upiqr.in/api/qr?name=${encodeURIComponent(name)}&vpa=${upi}&amount=${totalAmount}`;
      document.getElementById('upiQR').src = url;
      document.getElementById('qrText').innerText = `Scan & Pay ‚Çπ${totalAmount} to ${upi}`;
      document.getElementById('qrcode-container').style.display = 'block';
      document.getElementById('payButton').style.display = 'none';
      setTimeout(() => {
        document.getElementById('payment-confirmed').style.display = 'block';
      }, 30000); // 30 seconds
    };

    async function submitOrder() {
      const name = document.getElementById('customerName').value;
      const address = document.getElementById('customerAddress').value;
      const phone = document.getElementById('customerPhone').value;
      if (!name || !address || !phone || totalAmount === 0) {
        alert('Please fill all details and select menu.');
        return;
      }

      let orderItems = [];
      menuItems.forEach((item, i) => {
        if (document.getElementById(`item${i}`).checked) {
          const qty = parseInt(document.getElementById(`qty${i}`).value);
          orderItems.push(`${item.Item} x ${qty}`);
        }
      });

      const payload = {
        name, address, phone,
        order: orderItems.join(', '),
        amount: totalAmount
      };

      const params = new URLSearchParams(payload).toString();
      const response = await fetch(`${SHEET_SCRIPT_URL}?mode=submit&${params}`);

      if (CONFIG.TELEGRAM_BOT) {
        const tgMessage = `üßæ *New Order Received*\nüë§ Name: ${name}\nüìç Address: ${address}\nüìû Phone: ${phone}\nüç¥ Order: ${orderItems.join(', ')}\nüíµ Amount: ‚Çπ${totalAmount}`;
        fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: CONFIG.CHATID,
            text: tgMessage,
            parse_mode: 'Markdown'
          })
        });
      }

      alert('Thank you! Your order has been placed.');
      location.reload();
    }
  </script>
</body>
</html>
